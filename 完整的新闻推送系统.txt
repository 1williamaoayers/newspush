# åˆ›å»ºå®Œæ•´çš„æ–°é—»æ¨é€ç³»ç»Ÿ
# æ¸…ç†å¹¶é‡æ–°åˆ›å»ºç›®å½•
rm -rf /home/60s
mkdir -p /home/60s

# é…ç½®å˜é‡
SOURCE_URL="http://192.168.3.133:4399/v2/60s"
FEISHU_WEBHOOK_URL="https://www.feishu.cn/flow/api/trigger-webhook/e9eb3eb901b500ab55b2f44c50194268"

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /home/60s/config.conf << EOF
SOURCE_URL="$SOURCE_URL"
FEISHU_WEBHOOK_URL="$FEISHU_WEBHOOK_URL"
EOF

# åˆ›å»ºæ¨é€è„šæœ¬
cat > /home/60s/news_pusher.sh << 'EOF'
#!/bin/bash

# ä»é…ç½®æ–‡ä»¶åŠ è½½å˜é‡
source /home/60s/config.conf

LOG_FILE="/home/60s/daily_news_push.log"

# è®°å½•æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# è·å–60ç§’æ–°é—»æ•°æ®
fetch_60s_news() {
    local response
    response=$(curl -s -m 30 "http://192.168.3.133:4399/v2/60s")
    if [ $? -ne 0 ]; then
        log_message "ERROR: è·å–60ç§’æ–°é—»æ•°æ®å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥è¿”å›çš„JSONæ˜¯å¦æœ‰æ•ˆ
    if echo "$response" | jq -e .code >/dev/null 2>&1; then
        echo "$response"
        return 0
    else
        log_message "ERROR: 60ç§’æ–°é—»è¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
        return 1
    fi
}

# è·å–ç™¾åº¦çƒ­ç‚¹æ•°æ®
fetch_baidu_hot() {
    local response
    response=$(curl -s -m 30 "http://192.168.3.133:4399/v2/baidu/hot")
    if [ $? -ne 0 ]; then
        log_message "ERROR: è·å–ç™¾åº¦çƒ­ç‚¹æ•°æ®å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥è¿”å›çš„JSONæ˜¯å¦æœ‰æ•ˆ
    if echo "$response" | jq -e .code >/dev/null 2>&1; then
        echo "$response"
        return 0
    else
        log_message "ERROR: ç™¾åº¦çƒ­ç‚¹è¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
        return 1
    fi
}

# è·å–å¤´æ¡çƒ­ç‚¹æ•°æ®
fetch_toutiao_hot() {
    local response
    response=$(curl -s -m 30 "http://192.168.3.133:4399/v2/toutiao")
    if [ $? -ne 0 ]; then
        log_message "ERROR: è·å–å¤´æ¡çƒ­ç‚¹æ•°æ®å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥è¿”å›çš„JSONæ˜¯å¦æœ‰æ•ˆ
    if echo "$response" | jq -e .code >/dev/null 2>&1; then
        echo "$response"
        return 0
    else
        log_message "ERROR: å¤´æ¡çƒ­ç‚¹è¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
        return 1
    fi
}

# è·å–çŸ¥ä¹çƒ­ç‚¹æ•°æ®
fetch_zhihu_hot() {
    local response
    response=$(curl -s -m 30 "http://192.168.3.133:4399/v2/zhihu")
    if [ $? -ne 0 ]; then
        log_message "ERROR: è·å–çŸ¥ä¹çƒ­ç‚¹æ•°æ®å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥è¿”å›çš„JSONæ˜¯å¦æœ‰æ•ˆ
    if echo "$response" | jq -e .code >/dev/null 2>&1; then
        echo "$response"
        return 0
    else
        log_message "ERROR: çŸ¥ä¹çƒ­ç‚¹è¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
        return 1
    fi
}

# æ ¼å¼åŒ–60ç§’æ–°é—»æ¶ˆæ¯
format_60s_news() {
    local json_data="$1"
    
    # æ£€æŸ¥è¿”å›ç 
    local code
    code=$(echo "$json_data" | jq -r '.code')
    if [ "$code" != "200" ]; then
        log_message "ERROR: 60ç§’æ–°é—»APIè¿”å›é”™è¯¯ç : $code"
        return 1
    fi
    
    # æå–æ•°æ®
    local date_str
    local day_of_week
    local lunar_date
    local tip
    local news_list_json
    local link
    date_str=$(echo "$json_data" | jq -r '.data.date')
    day_of_week=$(echo "$json_data" | jq -r '.data.day_of_week')
    lunar_date=$(echo "$json_data" | jq -r '.data.lunar_date')
    tip=$(echo "$json_data" | jq -r '.data.tip')
    news_list_json=$(echo "$json_data" | jq '.data.news')
    link=$(echo "$json_data" | jq -r '.data.link')
    
    # æ„å»ºæ ‡é¢˜
    local message
    message="ã€æ¯æ—¥æ–°é—»ã€‘$date_str $day_of_week $lunar_date\n"
    message+=$(printf '=%.0s' {1..50})"\n\n"
    
    # æ·»åŠ æ¯æ—¥ä¸€è¨€
    if [ -n "$tip" ] && [ "$tip" != "null" ]; then
        message="${message}ğŸ’¡ $tip\n\n"
    fi
    
    # è·å–æ–°é—»åˆ—è¡¨å¹¶æ·»åŠ åˆ°æ¶ˆæ¯
    local news_count
    news_count=$(echo "$news_list_json" | jq 'length')
    for i in $(seq 0 $((news_count - 1))); do
        local news_item
        news_item=$(echo "$news_list_json" | jq -r ".[$i]")
        if [ -n "$news_item" ] && [ "$news_item" != "null" ]; then
            message="${message}$((i + 1)). $news_item\n\n"
        fi
    done
    
    # æ·»åŠ é“¾æ¥
    if [ -n "$link" ] && [ "$link" != "null" ]; then
        message="${message}ğŸ”— é˜…è¯»åŸæ–‡: $link\n\n"
    fi
    
    echo -e "$message"
}

# æ ¼å¼åŒ–çƒ­ç‚¹æ–°é—»æ¶ˆæ¯
format_hot_news() {
    local json_data="$1"
    local source_name="$2"
    
    # æ£€æŸ¥è¿”å›ç 
    local code
    code=$(echo "$json_data" | jq -r '.code')
    if [ "$code" != "200" ]; then
        log_message "ERROR: $source_name APIè¿”å›é”™è¯¯ç : $code"
        return 1
    fi
    
    # æå–æ•°æ®
    local hot_list_json
    hot_list_json=$(echo "$json_data" | jq '.data')
    
    # æ„å»ºæ ‡é¢˜
    local message
    message="ã€$source_name çƒ­ç‚¹ã€‘\n"
    message+=$(printf '=%.0s' {1..50})"\n\n"
    
    # è·å–çƒ­ç‚¹åˆ—è¡¨å¹¶æ·»åŠ åˆ°æ¶ˆæ¯
    local hot_count
    hot_count=$(echo "$hot_list_json" | jq 'length')
    for i in $(seq 0 $((hot_count - 1))); do
        local hot_item
        local hot_title
        local hot_url
        hot_item=$(echo "$hot_list_json" | jq ".[$i]")
        hot_title=$(echo "$hot_item" | jq -r '.title // .keyword // .title // .name // .query')
        hot_url=$(echo "$hot_item" | jq -r '.url // .link // .hotUrl // .article_url // "N/A"')
        
        if [ -n "$hot_title" ] && [ "$hot_title" != "null" ]; then
            message="${message}$((i + 1)). $hot_title\n"
            if [ -n "$hot_url" ] && [ "$hot_url" != "N/A" ] && [ "$hot_url" != "null" ]; then
                message="${message}   ğŸ”— $hot_url\n"
            fi
            message="${message}\n"
        fi
    done
    
    echo -e "$message"
}

# ç»„åˆæ‰€æœ‰æ¶ˆæ¯
combine_messages() {
    local msg_60s="$1"
    local msg_baidu="$2"
    local msg_toutiao="$3"
    local msg_zhihu="$4"
    
    local combined_message=""
    
    # æ·»åŠ 60ç§’æ–°é—»
    if [ -n "$msg_60s" ]; then
        combined_message+="$msg_60s\n"
    fi
    
    # æ·»åŠ ç™¾åº¦çƒ­ç‚¹
    if [ -n "$msg_baidu" ]; then
        combined_message+="$msg_baidu\n"
    fi
    
    # æ·»åŠ å¤´æ¡çƒ­ç‚¹
    if [ -n "$msg_toutiao" ]; then
        combined_message+="$msg_toutiao\n"
    fi
    
    # æ·»åŠ çŸ¥ä¹çƒ­ç‚¹
    if [ -n "$msg_zhihu" ]; then
        combined_message+="$msg_zhihu\n"
    fi
    
    # æ·»åŠ åº•éƒ¨ä¿¡æ¯
    combined_message+=$(printf '=%.0s' {1..50})"\n"
    combined_message+="æ¥æº: https://github.com/vikiboss/60s\n"
    
    echo -e "$combined_message"
}

# å‘é€æ¶ˆæ¯åˆ°é£ä¹¦
send_to_feishu() {
    local message="$1"
    
    # æ„å»ºJSONè½½è·
    local payload
    payload=$(printf '{
  "msg_type": "text",
  "content": {
    "text": "%s"
  }
}' "$(echo "$message" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')")

    # å‘é€è¯·æ±‚
    local response
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        --connect-timeout 10 \
        --max-time 30 \
        "$FEISHU_WEBHOOK_URL")
    
    if [ $? -eq 0 ]; then
        # æ£€æŸ¥å“åº”çŠ¶æ€ï¼Œæ ¹æ®å®é™…APIå“åº”è°ƒæ•´
        local status_code
        status_code=$(echo "$response" | jq -r '.StatusCode // .code // .status // .error_code // "unknown"')
        if [ "$status_code" = "0" ] || [ "$status_code" = "0" ] || [ "$status_code" = "success" ]; then
            log_message "INFO: æ¶ˆæ¯å‘é€æˆåŠŸ"
            return 0
        else
            log_message "ERROR: é£ä¹¦è¿”å›é”™è¯¯ - $(echo "$response" | jq -r '.msg // .message // .error_msg // "unknown error"')"
            echo "$response" >> $LOG_FILE
            return 1
        fi
    else
        log_message "ERROR: å‘é€è¯·æ±‚å¤±è´¥ï¼Œå“åº”: $response"
        return 1
    fi
}

# ä¸»æ‰§è¡Œå‡½æ•°
main() {
    log_message "INFO: å¼€å§‹æ‰§è¡Œæ¯æ—¥æ–°é—»æ¨é€ä»»åŠ¡"
    
    # è·å–å„ç§æ–°é—»æ•°æ®
    local news_60s=$(fetch_60s_news)
    local news_baidu=$(fetch_baidu_hot)
    local news_toutiao=$(fetch_toutiao_hot)
    local news_zhihu=$(fetch_zhihu_hot)
    
    # æ ¼å¼åŒ–å„ä¸ªæ¶ˆæ¯
    local formatted_60s=""
    local formatted_baidu=""
    local formatted_toutiao=""
    local formatted_zhihu=""
    
    if [ -n "$news_60s" ]; then
        formatted_60s=$(format_60s_news "$news_60s")
    fi
    
    if [ -n "$news_baidu" ]; then
        formatted_baidu=$(format_hot_news "$news_baidu" "ç™¾åº¦")
    fi
    
    if [ -n "$news_toutiao" ]; then
        formatted_toutiao=$(format_hot_news "$news_toutiao" "å¤´æ¡")
    fi
    
    if [ -n "$news_zhihu" ]; then
        formatted_zhihu=$(format_hot_news "$news_zhihu" "çŸ¥ä¹")
    fi
    
    # ç»„åˆæ‰€æœ‰æ¶ˆæ¯
    local combined_message=$(combine_messages "$formatted_60s" "$formatted_baidu" "$formatted_toutiao" "$formatted_zhihu")
    
    # å‘é€æ¶ˆæ¯åˆ°é£ä¹¦
    send_to_feishu "$combined_message"
    if [ $? -eq 0 ]; then
        log_message "INFO: æ¯æ—¥æ–°é—»æ¨é€å®Œæˆ"
    else
        log_message "ERROR: æ¯æ—¥æ–°é—»æ¨é€å¤±è´¥"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main
EOF

# åˆ›å»ºç®¡ç†è„šæœ¬
cat > /home/60s/manage.sh << 'EOF'
#!/bin/bash

CONFIG_PATH="/home/60s/config.conf"
SCRIPT_PATH="/home/60s/news_pusher.sh"
LOG_FILE="/home/60s/daily_news_push.log"
CRON_BACKUP="/home/60s/cron_backup.txt"

# æ˜¾ç¤ºèœå•
show_menu() {
    echo ""
    echo "=== 60ç§’æ–°é—»æ¨é€ç®¡ç† ==="
    echo "1. ç«‹å³æ¨é€ï¼ˆå¤šæºæ–°é—»+é“¾æ¥ï¼‰"
    echo "2. è®¾ç½®å®šæ—¶æ¨é€æ—¶é—´ï¼ˆæ¸…ç©ºåŸæœ‰ä»»åŠ¡ï¼Œæ”¯æŒæ‰¹é‡ï¼‰"
    echo "3. æ·»åŠ å®šæ—¶æ¨é€æ—¶é—´ï¼ˆä¿ç•™åŸæœ‰ä»»åŠ¡ï¼Œæ”¯æŒæ‰¹é‡ï¼‰"
    echo "4. æŸ¥çœ‹å½“å‰å®šæ—¶ä»»åŠ¡"
    echo "5. åˆ é™¤å®šæ—¶ä»»åŠ¡"
    echo "6. æ¸…ç©ºæ‰€æœ‰å®šæ—¶ä»»åŠ¡"
    echo "7. æŸ¥çœ‹æ—¥å¿—"
    echo "8. æµ‹è¯•APIè¿æ¥"
    echo "9. é€€å‡º"
    echo "========================"
    echo -n "è¯·é€‰æ‹©æ“ä½œ (1-9): "
}

# ç«‹å³æ¨é€
immediate_push() {
    echo "æ­£åœ¨æ‰§è¡Œç«‹å³æ¨é€..."
    $SCRIPT_PATH
    echo "ç«‹å³æ¨é€å®Œæˆï¼ŒæŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š"
    tail -n 20 $LOG_FILE
}

# è®¾ç½®å®šæ—¶æ¨é€æ—¶é—´ï¼ˆæ¸…ç©ºåŸæœ‰ä»»åŠ¡ï¼Œæ”¯æŒæ‰¹é‡ï¼‰
set_schedule() {
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
    echo ""
    
    # æ¸…ç©ºç°æœ‰ä»»åŠ¡
    crontab -l 2>/dev/null | grep -v "news_pusher.sh" | crontab -
    echo "å·²æ¸…ç©ºåŸæœ‰å®šæ—¶ä»»åŠ¡"
    
    echo "è¯·è¾“å…¥æ¨é€æ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MM,HH:MM,HH:MMï¼Œä¾‹å¦‚ 09:00,10:00,12:00ï¼‰ï¼š"
    read -p "æ—¶é—´: " time_input
    
    # æŒ‰é€—å·åˆ†å‰²æ—¶é—´
    IFS=',' read -ra times <<< "$time_input"
    
    for time_str in "${times[@]}"; do
        # å»é™¤ç©ºæ ¼
        time_str=$(echo "$time_str" | xargs)
        
        # éªŒè¯æ—¶é—´æ ¼å¼
        if [[ ! $time_str =~ ^[0-2][0-9]:[0-5][0-9]$ ]]; then
            echo "é”™è¯¯ï¼šæ—¶é—´æ ¼å¼ä¸æ­£ç¡® '$time_str'ï¼Œè¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆä¾‹å¦‚ 09:00ï¼‰"
            continue
        fi
        
        # åˆ†å‰²å°æ—¶å’Œåˆ†é’Ÿ
        IFS=':' read -r hour minute <<< "$time_str"
        
        # éªŒè¯å°æ—¶å’Œåˆ†é’ŸèŒƒå›´
        if [ $hour -lt 0 ] || [ $hour -gt 23 ] || [ $minute -lt 0 ] || [ $minute -gt 59 ]; then
            echo "é”™è¯¯ï¼šæ—¶é—´è¶…å‡ºèŒƒå›´ '$time_str'ï¼ˆå°æ—¶: 0-23ï¼Œåˆ†é’Ÿ: 0-59ï¼‰"
            continue
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å®šæ—¶ä»»åŠ¡
        if crontab -l 2>/dev/null | grep -q "$minute $hour \* \* \* $SCRIPT_PATH"; then
            echo "è­¦å‘Šï¼šå®šæ—¶ä»»åŠ¡ $hour:$minute å·²å­˜åœ¨"
            continue
        fi
        
        # æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡
        (crontab -l 2>/dev/null; echo "$minute $hour * * * $SCRIPT_PATH") | crontab -
        echo "å®šæ—¶ä»»åŠ¡å·²æ·»åŠ ï¼šæ¯å¤© $hour:$minute æ‰§è¡Œ"
    done
    
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
}

# æ·»åŠ å®šæ—¶æ¨é€æ—¶é—´ï¼ˆä¿ç•™åŸæœ‰ä»»åŠ¡ï¼Œæ”¯æŒæ‰¹é‡ï¼‰
add_schedule() {
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
    echo ""
    
    echo "è¯·è¾“å…¥æ¨é€æ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MM,HH:MM,HH:MMï¼Œä¾‹å¦‚ 09:00,10:00,12:00ï¼‰ï¼š"
    read -p "æ—¶é—´: " time_input
    
    # æŒ‰é€—å·åˆ†å‰²æ—¶é—´
    IFS=',' read -ra times <<< "$time_input"
    
    for time_str in "${times[@]}"; do
        # å»é™¤ç©ºæ ¼
        time_str=$(echo "$time_str" | xargs)
        
        # éªŒè¯æ—¶é—´æ ¼å¼
        if [[ ! $time_str =~ ^[0-2][0-9]:[0-5][0-9]$ ]]; then
            echo "é”™è¯¯ï¼šæ—¶é—´æ ¼å¼ä¸æ­£ç¡® '$time_str'ï¼Œè¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆä¾‹å¦‚ 09:00ï¼‰"
            continue
        fi
        
        # åˆ†å‰²å°æ—¶å’Œåˆ†é’Ÿ
        IFS=':' read -r hour minute <<< "$time_str"
        
        # éªŒè¯å°æ—¶å’Œåˆ†é’ŸèŒƒå›´
        if [ $hour -lt 0 ] || [ $hour -gt 23 ] || [ $minute -lt 0 ] || [ $minute -gt 59 ]; then
            echo "é”™è¯¯ï¼šæ—¶é—´è¶…å‡ºèŒƒå›´ '$time_str'ï¼ˆå°æ—¶: 0-23ï¼Œåˆ†é’Ÿ: 0-59ï¼‰"
            continue
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å®šæ—¶ä»»åŠ¡
        if crontab -l 2>/dev/null | grep -q "$minute $hour \* \* \* $SCRIPT_PATH"; then
            echo "è­¦å‘Šï¼šå®šæ—¶ä»»åŠ¡ $hour:$minute å·²å­˜åœ¨"
            continue
        fi
        
        # æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡
        (crontab -l 2>/dev/null; echo "$minute $hour * * * $SCRIPT_PATH") | crontab -
        echo "å®šæ—¶ä»»åŠ¡å·²æ·»åŠ ï¼šæ¯å¤© $hour:$minute æ‰§è¡Œ"
    done
    
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
}

# æŸ¥çœ‹å½“å‰å®šæ—¶ä»»åŠ¡
view_schedule() {
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
}

# åˆ é™¤å®šæ—¶ä»»åŠ¡
remove_schedule() {
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    local current_tasks
    current_tasks=$(crontab -l 2>/dev/null | grep "news_pusher.sh")
    
    if [ -z "$current_tasks" ]; then
        echo "æ— å®šæ—¶ä»»åŠ¡"
        return
    fi
    
    echo "$current_tasks"
    echo ""
    echo "è¯·è¾“å…¥è¦åˆ é™¤çš„å®šæ—¶ä»»åŠ¡æ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MMï¼Œä¾‹å¦‚ 09:00ï¼‰ï¼š"
    read -p "æ—¶é—´: " time_input
    
    # éªŒè¯æ—¶é—´æ ¼å¼
    if [[ ! $time_input =~ ^[0-2][0-9]:[0-5][0-9]$ ]]; then
        echo "é”™è¯¯ï¼šæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆä¾‹å¦‚ 09:00ï¼‰"
        return 1
    fi
    
    # åˆ†å‰²å°æ—¶å’Œåˆ†é’Ÿ
    IFS=':' read -r hour minute <<< "$time_input"
    
    # éªŒè¯å°æ—¶å’Œåˆ†é’ŸèŒƒå›´
    if [ $hour -lt 0 ] || [ $hour -gt 23 ] || [ $minute -lt 0 ] || [ $minute -gt 59 ]; then
        echo "é”™è¯¯ï¼šæ—¶é—´è¶…å‡ºèŒƒå›´ï¼ˆå°æ—¶: 0-23ï¼Œåˆ†é’Ÿ: 0-59ï¼‰"
        return 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥å®šæ—¶ä»»åŠ¡
    if ! crontab -l 2>/dev/null | grep -q "$minute $hour \* \* \* $SCRIPT_PATH"; then
        echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®šæ—¶ä»»åŠ¡ $hour:$minute"
        return 1
    fi
    
    # ç¡®è®¤åˆ é™¤
    read -p "ç¡®å®šè¦åˆ é™¤å®šæ—¶ä»»åŠ¡ $hour:$minute å—ï¼Ÿ(y/N): " confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ] || [ "$confirm" = "yes" ] || [ "$confirm" = "YES" ]; then
        # åˆ é™¤åŒ¹é…çš„å®šæ—¶ä»»åŠ¡
        crontab -l 2>/dev/null | grep -v "$minute $hour \* \* \* $SCRIPT_PATH" | crontab -
        echo "å®šæ—¶ä»»åŠ¡ $hour:$minute å·²åˆ é™¤"
    else
        echo "æ“ä½œå·²å–æ¶ˆ"
    fi
}

# æ¸…ç©ºæ‰€æœ‰å®šæ—¶ä»»åŠ¡
clear_all_schedules() {
    echo "å½“å‰å®šæ—¶ä»»åŠ¡ï¼š"
    crontab -l 2>/dev/null | grep "news_pusher.sh" || echo "æ— å®šæ—¶ä»»åŠ¡"
    
    if crontab -l 2>/dev/null | grep -q "news_pusher.sh"; then
        read -p "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å®šæ—¶ä»»åŠ¡å—ï¼Ÿ(y/N): " confirm
        if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ] || [ "$confirm" = "yes" ] || [ "$confirm" = "YES" ]; then
            crontab -l 2>/dev/null | grep -v "news_pusher.sh" | crontab -
            echo "æ‰€æœ‰å®šæ—¶ä»»åŠ¡å·²æ¸…ç©º"
        else
            echo "æ“ä½œå·²å–æ¶ˆ"
        fi
    else
        echo "æ²¡æœ‰å®šæ—¶ä»»åŠ¡éœ€è¦æ¸…ç©º"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    echo "æœ€è¿‘20æ¡æ—¥å¿—ï¼š"
    tail -n 20 $LOG_FILE
    echo ""
    read -p "æ˜¯å¦æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼Ÿ(y/N): " confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ] || [ "$confirm" = "yes" ] || [ "$confirm" = "YES" ]; then
        less $LOG_FILE
    fi
}

# æµ‹è¯•APIè¿æ¥
test_apis() {
    echo "æµ‹è¯•APIè¿æ¥..."
    echo ""
    
    echo "æµ‹è¯•60ç§’æ–°é—»API: http://192.168.3.133:4399/v2/60s"
    curl -s -m 10 "http://192.168.3.133:4399/v2/60s" | jq -r '.code' 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "âœ“ 60ç§’æ–°é—»APIè¿æ¥æ­£å¸¸"
    else
        echo "âœ— 60ç§’æ–°é—»APIè¿æ¥å¤±è´¥"
    fi
    echo ""
    
    echo "æµ‹è¯•ç™¾åº¦çƒ­ç‚¹API: http://192.168.3.133:4399/v2/baidu/hot"
    curl -s -m 10 "http://192.168.3.133:4399/v2/baidu/hot" | jq -r '.code' 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "âœ“ ç™¾åº¦çƒ­ç‚¹APIè¿æ¥æ­£å¸¸"
    else
        echo "âœ— ç™¾åº¦çƒ­ç‚¹APIè¿æ¥å¤±è´¥"
    fi
    echo ""
    
    echo "æµ‹è¯•å¤´æ¡çƒ­ç‚¹API: http://192.168.3.133:4399/v2/toutiao"
    curl -s -m 10 "http://192.168.3.133:4399/v2/toutiao" | jq -r '.code' 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "âœ“ å¤´æ¡çƒ­ç‚¹APIè¿æ¥æ­£å¸¸"
    else
        echo "âœ— å¤´æ¡çƒ­ç‚¹APIè¿æ¥å¤±è´¥"
    fi
    echo ""
    
    echo "æµ‹è¯•çŸ¥ä¹çƒ­ç‚¹API: http://192.168.3.133:4399/v2/zhihu"
    curl -s -m 10 "http://192.168.3.133:4399/v2/zhihu" | jq -r '.code' 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "âœ“ çŸ¥ä¹çƒ­ç‚¹APIè¿æ¥æ­£å¸¸"
    else
        echo "âœ— çŸ¥ä¹çƒ­ç‚¹APIè¿æ¥å¤±è´¥"
    fi
    echo ""
}

# ä¸»å¾ªç¯
while true; do
    show_menu
    read choice
    
    case $choice in
        1)
            immediate_push
            ;;
        2)
            set_schedule
            ;;
        3)
            add_schedule
            ;;
        4)
            view_schedule
            ;;
        5)
            remove_schedule
            ;;
        6)
            clear_all_schedules
            ;;
        7)
            view_logs
            ;;
        8)
            test_apis
            ;;
        9)
            echo "é€€å‡ºç®¡ç†è„šæœ¬"
            exit 0
            ;;
        *)
            echo "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©"
            ;;
    esac
    
    echo ""
    echo "æŒ‰ä»»æ„é”®ç»§ç»­..."
    read -n 1 -s
done
EOF

# åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬
cat > /home/60s/cleanup_logs.sh << 'EOF'
#!/bin/bash
# æ¸…ç†è¶…è¿‡7å¤©çš„æ—¥å¿—æ–‡ä»¶
find /home/60s -name "daily_news_push.log" -type f -mtime +7 -delete
EOF

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /home/60s/news_pusher.sh
chmod +x /home/60s/manage.sh
chmod +x /home/60s/cleanup_logs.sh

# è®¾ç½®æ—¥å¿—æ¸…ç†ä»»åŠ¡ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * 0 /home/60s/cleanup_logs.sh") | crontab -

echo "å®Œæ•´çš„æ–°é—»æ¨é€ç³»ç»Ÿå·²å®‰è£…å®Œæˆï¼"
echo ""
echo "ç³»ç»ŸåŠŸèƒ½ï¼š"
echo "1. æ”¯æŒå¤šAPIæºï¼š60ç§’æ–°é—»ã€ç™¾åº¦çƒ­ç‚¹ã€å¤´æ¡çƒ­ç‚¹ã€çŸ¥ä¹çƒ­ç‚¹"
echo "2. æ–°é—»å†…å®¹åŒ…å«é“¾æ¥ï¼Œæ–¹ä¾¿ç‚¹å‡»é˜…è¯»"
echo "3. æ”¯æŒæ‰¹é‡è®¾ç½®å®šæ—¶æ¨é€æ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MM,HH:MM,HH:MMï¼‰"
echo "4. æä¾›å®Œæ•´çš„ç®¡ç†ç•Œé¢"
echo "5. è‡ªåŠ¨æ—¥å¿—è®°å½•å’Œæ¸…ç†"
echo ""
echo "ä½¿ç”¨æ–¹æ³•ï¼š"
echo "cd /home/60s && ./manage.sh"
echo ""
echo "ç›®å½•ç»“æ„ï¼š"
ls -la /home/60s/



